<div id="shuffled-synopsis-container">
  <div id="shuffled-synopsis-title">あらすじ</div>
  <div id="shuffled-synopsis"></div>
</div>

<div id="movie-info-popup">
  <div id="popup-title"></div>
  <img id="popup-image" src="" alt="Movie Image">
</div>

<style>
/* コンテナ全体のスタイリング */
#shuffled-synopsis-container {
  top: -50px;
  overflow-y: auto;
  padding: 20px;
  position: relative;
  height: 300px;
  width: 90%;
  margin: 0 auto; /* コンテナを中央に配置 */
  background: #e0f7fa; /* 薄い明るい青 */
  box-sizing: border-box; /* パディングとボーダーを含めて幅を計算 */
  border-radius: 240px 15px 100px 15px / 15px 200px 15px 185px;
  border: 3px solid #333;
}

/* タイピングエフェクト部分のスタイリング */
/* タイピングエフェクトのスタイル */
.typing-effect {
  white-space: nowrap;
  overflow: hidden;
  border-right: 2px solid black; /* キャレットのスタイル */
  animation: typing 2s steps(40, end), blink-caret .75s step-end infinite;
}

@keyframes typing {
  from { width: 0; }
  to { width: 100%; }
}

@keyframes blink-caret {
  from, to { border-color: transparent; }
  50% { border-color: black; }
}

#shuffled-synopsis-title {
  font-size: 16pt;
  font-weight: bold;
  text-align: center;
  color: #333; /* タイトルの色 */
  animation: bounce 0.5s ease-in-out 3; /* アニメーションの設定（3回だけ繰り返す） */
}



/* タイピングエフェクト部分のスタイリング */
#shuffled-synopsis {
  position: relative;
  white-space: pre-wrap; /* テキストをそのまま改行 */
}

/* 映画情報ポップアップのスタイリング */
#movie-info-popup {
  position: absolute;
  display: none;
  background-color: white;
  border: 1px solid black;
  padding: 10px;
  z-index: 1000; /* ポップアップの z-index */
  max-width: 300px;
  max-height: 200px;
  overflow: hidden;
}


/* ポップアップ内の画像のスタイリング */
#popup-image {
  max-width: 100%; /* 画像の最大幅を親要素に合わせる */
  max-height: 150px; /* 画像の最大高さを設定 */
  display: block; /* 画像の余白をなくす */
}


/* リンクのスタイル */
.movie-link {
  color: black;
  text-decoration: none;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const titleText = 'あらすじ';
  const text = `<%= j @shuffled_synopsis %>`;
  const titleElement = document.getElementById('shuffled-synopsis-title');
  const container = document.getElementById('shuffled-synopsis');
  const popup = document.getElementById('movie-info-popup');
  const popupTitle = document.getElementById('popup-title');
  const popupImage = document.getElementById('popup-image');
  let index = 0;

  // タイトルにタイピングエフェクトを追加
  function typeTitle() {
    if (index < titleText.length) {
      titleElement.textContent = titleText.substring(0, index + 1);
      index++;
      setTimeout(typeTitle, 100); // タイピングの速度
    } else {
      index = 0;
      type(); // タイトルが終わったらあらすじのタイピングを開始
    }
  }

  function type() {
    if (index < text.length) {
      container.innerHTML = text.substring(0, index + 1);
      index++;
      setTimeout(type, 10); // タイピングの速度を速くする
    } else {
      enableLinksAndHoverEvents(); // 全てのリンクを有効にし、ホバーイベントを設定
      localStorage.setItem('shuffledSynopsis', container.innerHTML); // 表示された内容を保存
    }
  }

  function enableLinksAndHoverEvents() {
    document.querySelectorAll('.movie-link').forEach(link => {
      link.addEventListener('mouseover', (event) => {
        const movieInfo = event.target.dataset.movieInfo;
        const movieImage = event.target.dataset.movieImage;
        popupTitle.textContent = movieInfo;
        popupImage.src = movieImage;
  
        popup.style.display = 'block';
  
        let top = event.clientY + window.scrollY + 10;
        let left = event.clientX + window.scrollX + 10;
  
        // ポップアップの幅と高さを取得
        const popupWidth = popup.offsetWidth;
        const popupHeight = popup.offsetHeight;
  
        // 画面の右端にはみ出ないように調整
        if (left + popupWidth > window.innerWidth + window.scrollX) {
          left = window.innerWidth + window.scrollX - popupWidth - 10;
        }
  
        // 画面の下端にはみ出ないように調整
        if (top + popupHeight > window.innerHeight + window.scrollY) {
          top = window.innerHeight + window.scrollY - popupHeight - 10;
        }
  
        popup.style.top = `${top}px`;
        popup.style.left = `${left}px`;
      });
  
      link.addEventListener('mouseout', () => {
        popup.style.display = 'none';
      });
    });
  }
  
  // タイトルのタイピングエフェクトを開始
  typeTitle();
});
</script>